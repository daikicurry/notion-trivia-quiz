<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雑学クイズ</title>
    <style>
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .quiz-display {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            min-height: 100px;
        }
        .tag-sections {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .tag-section {
            flex: 1;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .tag-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .tag-input input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .tag-input button {
            padding: 5px 10px;
        }
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            min-height: 30px;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            background-color: #e0e0e0;
            border-radius: 15px;
            font-size: 14px;
        }
        .include-tag {
            background-color: #2196f3;
            color: white;
        }
        .exclude-tag {
            background-color: #f44336;
            color: white;
        }
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
        }
        .button-container {
            margin-top: 20px;
        }
        .control-button {
            margin: 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #2196f3;
            color: white;
            cursor: pointer;
        }
        .control-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <h1>雑学クイズ</h1>
        
        <div class="tag-sections">
            <div class="tag-section">
                <h3>含めるタグ</h3>
                <div class="tag-input">
                    <input type="text" id="includeTagInput" list="availableTags" placeholder="タグを入力">
                    <button onclick="addIncludeTag()">追加</button>
                </div>
                <div id="includedTags" class="selected-tags"></div>
            </div>
            
            <div class="tag-section">
                <h3>除外するタグ</h3>
                <div class="tag-input">
                    <input type="text" id="excludeTagInput" list="availableTags" placeholder="タグを入力">
                    <button onclick="addExcludeTag()">追加</button>
                </div>
                <div id="excludedTags" class="selected-tags"></div>
            </div>
        </div>

        <datalist id="availableTags">
            <!-- タグの候補がここに動的に追加されます -->
        </datalist>

        <div id="quizDisplay" class="quiz-display">
            スタートボタンを押してください
        </div>

        <div class="button-container">
            <button id="startButton" class="control-button">スタート</button>
            <button id="showSupplementButton" class="control-button" disabled>補足を表示</button>
            <button id="showNotionButton" class="control-button" disabled>Notionで開く</button>
            <button id="nextButton" class="control-button" disabled>次の問題</button>
        </div>
    </div>

    <script>
        let quizData = [];
        let currentQuiz = null;
        let supplementShown = false;
        let availableTags = new Set();
        const includedTags = new Set();
        const excludedTags = new Set();

        async function fetchQuizData() {
            try {
                const queryParams = new URLSearchParams();
                if (includedTags.size > 0) {
                    queryParams.set('includeTags', Array.from(includedTags).join(','));
                }
                if (excludedTags.size > 0) {
                    queryParams.set('excludeTags', Array.from(excludedTags).join(','));
                }

                const response = await fetch(`/.netlify/functions/getVocab?${queryParams.toString()}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('API Error:', data.error);
                    document.getElementById('quizDisplay').textContent = 'データの取得に失敗しました';
                    return [];
                }

                quizData = data.results;
                
                // 利用可能なタグを更新
                if (data.availableTags) {
                    updateAvailableTags(data.availableTags);
                }

                return data.results;
            } catch (error) {
                console.error('Error fetching quiz data:', error);
                document.getElementById('quizDisplay').textContent = 'データの取得に失敗しました';
                return [];
            }
        }

        function updateAvailableTags(tags) {
            const datalist = document.getElementById('availableTags');
            datalist.innerHTML = '';
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                datalist.appendChild(option);
                availableTags.add(tag);
            });
        }

        function addTag(tag, isExclude) {
            if (!tag || !availableTags.has(tag)) return;

            const targetSet = isExclude ? excludedTags : includedTags;
            const oppositeSet = isExclude ? includedTags : excludedTags;
            const targetContainer = document.getElementById(isExclude ? 'excludedTags' : 'includedTags');
            
            // 反対側のセットから削除
            oppositeSet.delete(tag);
            document.getElementById(isExclude ? 'includedTags' : 'excludedTags')
                .querySelectorAll('.tag').forEach(el => {
                    if (el.dataset.tag === tag) el.remove();
                });

            // 新しいタグを追加
            if (!targetSet.has(tag)) {
                targetSet.add(tag);
                const tagElement = document.createElement('span');
                tagElement.className = `tag ${isExclude ? 'exclude-tag' : 'include-tag'}`;
                tagElement.dataset.tag = tag;
                tagElement.innerHTML = `${tag} <span class="tag-remove" onclick="removeTag('${tag}', ${isExclude})">×</span>`;
                targetContainer.appendChild(tagElement);
                
                // タグ入力欄をクリア
                document.getElementById(isExclude ? 'excludeTagInput' : 'includeTagInput').value = '';
                
                // データを再取得
                fetchQuizData();
            }
        }

        function addIncludeTag() {
            const input = document.getElementById('includeTagInput');
            addTag(input.value, false);
        }

        function addExcludeTag() {
            const input = document.getElementById('excludeTagInput');
            addTag(input.value, true);
        }

        function removeTag(tag, isExclude) {
            const targetSet = isExclude ? excludedTags : includedTags;
            targetSet.delete(tag);
            document.getElementById(isExclude ? 'excludedTags' : 'includedTags')
                .querySelectorAll('.tag').forEach(el => {
                    if (el.dataset.tag === tag) el.remove();
                });
            fetchQuizData();
        }

        function getRandomQuiz() {
            if (quizData.length === 0) return null;
            const randomIndex = Math.floor(Math.random() * quizData.length);
            return quizData[randomIndex];
        }

        function updateButtons(state) {
            document.getElementById('startButton').disabled = state === 'quiz';
            document.getElementById('showSupplementButton').disabled = state !== 'quiz' || supplementShown;
            document.getElementById('showNotionButton').disabled = state !== 'quiz';
            document.getElementById('nextButton').disabled = state !== 'quiz';
        }

        async function startQuiz() {
            const data = await fetchQuizData();
            if (data.length === 0) {
                document.getElementById('quizDisplay').textContent = '条件に一致するクイズデータがありません';
                updateButtons('no-data');
                return;
            }

            currentQuiz = getRandomQuiz();
            if (currentQuiz) {
                document.getElementById('quizDisplay').textContent = currentQuiz.content;
                supplementShown = false;
                updateButtons('quiz');
            }
        }

        function showSupplement() {
            if (currentQuiz) {
                document.getElementById('quizDisplay').innerHTML = 
                    `<div>${currentQuiz.content}</div>
                     <hr>
                     <div>${currentQuiz.supplement}</div>`;
                supplementShown = true;
                updateButtons('quiz');
            }
        }

        function openInNotion() {
            if (currentQuiz) {
                window.open(currentQuiz.url, '_blank');
            }
        }

        // イベントリスナーの設定
        document.getElementById('startButton').onclick = startQuiz;
        document.getElementById('showSupplementButton').onclick = showSupplement;
        document.getElementById('showNotionButton').onclick = openInNotion;
        document.getElementById('nextButton').onclick = startQuiz;

        // 初期データの読み込み
        fetchQuizData();

        // エンターキーでタグを追加
        document.getElementById('includeTagInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addIncludeTag();
        });
        document.getElementById('excludeTagInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addExcludeTag();
        });
    </script>
</body>
</html>
